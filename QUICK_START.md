# 快速开始指南

## 前置条件

- Python 3.8+
- 阿里云百炼API Key

## 步骤1: 配置环境变量

1. 复制环境变量模板：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，填入你的API Key：
```env
DASHSCOPE_API_KEY=sk-your-actual-api-key-here
```

## 步骤2: 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- `langchain-openai==0.1.0` - LangChain的OpenAI集成
- `langchain-chroma` - 向量存储
- `chromadb` - 向量数据库
- `fastapi` - Web框架

## 步骤3: 测试配置

运行测试脚本验证配置是否正确：

```bash
python test_api_setup.py
```

预期输出：
```
==================================================
阿里云API配置和功能测试
==================================================

==================================================
测试环境变量配置
==================================================
✓ DASHSCOPE_API_KEY: sk-463211...ddfe
✓ EMBEDDING_MODEL: text-embedding-v3
✓ LLM_MODEL: qwen-plus
✓ RELEVANCE_THRESHOLD: 0.5

==================================================
测试Embedding功能
==================================================
测试文本: 这是一个测试文本
✓ Embedding生成成功
  维度: 1536
  前5个值: [0.123, -0.456, ...]

==================================================
测试LLM功能
==================================================
测试提示: 请用一句话介绍你自己。
✓ LLM调用成功
  回答: 我是通义千问...

==================================================
测试文档切割器
==================================================
测试文本长度: 123 字符
✓ 文档切割成功
  切割块数: 2

==================================================
测试相关性评估器
==================================================
测试查询: 薪资什么时候发放？
✓ 相关性评估成功
  是否相关: True
  最高分数: 0.800
  平均分数: 0.567
  相关文档数: 2/3

==================================================
测试结果汇总
==================================================
环境变量配置: ✓ 通过
Embedding功能: ✓ 通过
LLM功能: ✓ 通过
文档切割器: ✓ 通过
相关性评估器: ✓ 通过

总计: 5/5 通过

🎉 所有测试通过！系统配置正确。
```

## 步骤4: 启动服务

```bash
python main.py
```

服务将在 `http://localhost:8000` 启动。

## 步骤5: 测试功能

### 5.1 健康检查

访问：`http://localhost:8000/health`

预期响应：
```json
{
  "status": "ok",
  "service": "人事知识库系统",
  "detail": {
    "version": "2.0",
    "mode": "api",
    "components": {
      "vector_db": "active",
      "llm_integration": "alibaba_cloud",
      "api_server": "active",
      "query_router": "active"
    }
  }
}
```

### 5.2 上传文档

使用前端界面或API上传人事文档（支持 .pdf, .docx, .txt, .md）。

文档将被：
1. 智能切割（识别章节结构）
2. 生成向量（使用阿里云Embedding API）
3. 存储到ChromaDB

### 5.3 查询测试

#### 测试1: 相关查询（应该使用文档回答）

查询：`"薪资发放时间是什么时候？"`

预期行为：
- 向量检索找到相关文档
- 相关性评估通过（分数 > 0.5）
- 路由策略：`document_based`
- 基于文档内容生成回答

#### 测试2: 不相关查询（应该使用通用知识回答）

查询：`"今天天气怎么样？"`

预期行为：
- 向量检索找不到相关文档
- 相关性评估不通过（分数 < 0.5）
- 路由策略：`general_knowledge`
- 使用LLM通用知识回答，并礼貌说明主要负责人事问题

## 常见问题

### Q1: 测试脚本报错 "DASHSCOPE_API_KEY环境变量未设置"

**A**: 检查 `.env` 文件是否存在，并确认 `DASHSCOPE_API_KEY` 已正确配置。

### Q2: Embedding测试失败

**A**: 
1. 检查API Key是否有效
2. 检查网络连接
3. 确认阿里云账户余额充足

### Q3: 上传文档后查询总是返回通用回答

**A**: 
1. 检查文档是否成功上传（查看日志）
2. 检查相关性阈值配置（默认0.5）
3. 查看日志中的相似度分数

### Q4: ChromaDB初始化失败

**A**: 
1. 删除 `chroma_db` 目录
2. 重启服务

## 查看日志

日志文件位置：`./log/hr_kb_log_YYYYMMDD.log`

查看实时日志：
```bash
tail -f ./log/hr_kb_log_20241226.log
```

## 下一步

- 阅读 `DEV_API_README.md` 了解详细的技术文档
- 阅读 `IMPLEMENTATION_SUMMARY.md` 了解实现细节
- 根据实际使用情况调优配置参数

## 技术支持

如遇到问题：
1. 查看日志文件
2. 运行测试脚本诊断
3. 查阅文档
4. 检查环境配置

## 配置调优建议

### 相关性阈值 (RELEVANCE_THRESHOLD)

- **0.3-0.4**: 宽松模式，更多查询使用文档回答
- **0.5**: 默认值，平衡模式（推荐）
- **0.6-0.7**: 严格模式，只有高度相关才使用文档回答

### 文档切割大小 (CHUNK_SIZE)

- **800-1000**: 适合短文档
- **1200**: 默认值（推荐）
- **1500-2000**: 适合长文档

### 检索结果数量 (MAX_SEARCH_RESULTS)

- **3**: 快速响应
- **5**: 默认值（推荐）
- **10**: 更全面的检索

## 性能优化

1. **缓存策略**: 考虑添加查询缓存
2. **批量处理**: 批量上传文档时使用批量API
3. **异步处理**: 使用异步接口提高并发性能
4. **监控告警**: 设置API调用量监控和告警

## 安全建议

1. **API Key管理**: 
   - 不要将API Key提交到代码仓库
   - 定期轮换API Key
   - 使用环境变量或密钥管理服务

2. **访问控制**:
   - 配置防火墙规则
   - 使用HTTPS
   - 实现用户认证和授权

3. **数据安全**:
   - 定期备份向量数据库
   - 加密敏感数据
   - 实现审计日志

祝使用愉快！🎉
