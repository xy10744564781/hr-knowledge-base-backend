# 信息来源标识功能说明

## 功能概述

系统会明确标注AI回答的信息来源，让用户清楚知道回答是基于公司文档还是AI通用知识。

## 两种信息来源及显示方式

### 1. 📄 基于公司上传的文档

当系统在向量数据库中找到相关的公司文档时，回答会基于这些文档内容生成。

**显示方式：**
- ❌ **不在开头**显示"信息来源"标识（避免重复）
- ✅ 在**【文档依据】**部分列出引用的文档片段
- ✅ 在**回答末尾**显示"📌 参考文档"列表

**示例格式：**
```
【问题理解】
用户询问...

【文档依据】
【文档1】人事管理流程.docx：...
【文档2】人事管理流程.docx：...

【详细解答】
...

【操作步骤】
...

【注意事项】
...

📌 参考文档：
【文档1】人事管理流程.docx
【文档2】人事管理流程.docx
```

**特点：**
- 回答内容来自公司实际上传的人事文档
- 准确性高，符合公司实际政策
- 【文档依据】部分说明了信息来源
- 末尾的参考文档列表便于追溯

### 2. 💡 基于AI通用知识

当系统在向量数据库中没有找到足够相关的文档时，会使用AI的通用知识回答。

**显示方式：**
- ✅ 在**开头**显示"💡 信息来源：AI通用知识（非公司文档）"
- ⚠️ 提醒用户这不是来自公司文档

**示例格式：**
```
💡 信息来源：AI通用知识（非公司文档）

【回答内容】
...

【温馨提示】
此回答基于AI通用知识，如需了解公司具体政策，请联系人事部门或查阅公司文档。
```

**特点：**
- 回答内容来自AI模型的通用知识
- 可能不完全符合公司具体政策
- 明确标注提醒用户核实
- 建议联系人事部门确认

## 设计理念

### 为什么基于文档的回答不在开头显示"信息来源"？

1. **避免重复**：【文档依据】部分已经详细列出了引用的文档，再在开头标注会显得冗余
2. **更专业**：直接进入正题，符合专业文档的写作习惯
3. **信息更丰富**：【文档依据】不仅说明了来源，还展示了具体引用内容
4. **末尾有总结**：参考文档列表提供了完整的来源追溯

### 为什么通用知识回答要在开头标注？

1. **立即警示**：用户第一时间知道这不是公司文档
2. **避免误解**：防止用户误以为是公司政策
3. **提高透明度**：明确告知信息的局限性

## 技术实现

### 1. 提示词优化

**基于文档的提示词**：
```python
prompt = f"""
{system_prompt}

用户问题：{question}
相关文档：{context_docs}

**重要：不要在回答开头添加"信息来源"标识，因为【文档依据】部分已经说明了来源。**

请按照回答格式模板回答，确保：
1. 【文档依据】部分列出引用的文档
2. 在回答末尾添加"📌 参考文档"列表
"""
```

**通用知识的提示词**：
```python
prompt = f"""
用户问题：{question}

**重要：请在回答开头添加"💡 信息来源：AI通用知识（非公司文档）"**

回答格式：
💡 信息来源：AI通用知识（非公司文档）

【回答内容】...
【温馨提示】...
"""
```

### 2. 响应数据结构

API响应的`source_data`中包含来源信息：

```json
{
  "source_data": [{
    "source_type": "company_documents",  // 或 "general_knowledge"
    "source_description": "已上传的公司文档",
    "document_titles": ["人事管理流程.docx"],
    "result_count": 5
  }]
}
```

### 3. 流式响应

- **基于文档**：直接开始输出回答内容，不添加开头标识
- **通用知识**：先输出"💡 信息来源：AI通用知识（非公司文档）"

## 用户体验

### 前端显示建议

#### 基于文档的回答

```
┌─────────────────────────────────────────┐
│ 【问题理解】                             │
│ 用户询问员工转正流程...                 │
│                                         │
│ 【文档依据】                             │
│ 【文档1】人事管理流程.docx：...         │
│ 【文档2】人事管理流程.docx：...         │
│                                         │
│ 【详细解答】                             │
│ ...                                     │
│                                         │
│ 📌 参考文档：                           │
│ • 人事管理流程.docx                     │
└─────────────────────────────────────────┘
```

#### 通用知识回答

```
┌─────────────────────────────────────────┐
│ 💡 信息来源：AI通用知识（非公司文档）    │
├─────────────────────────────────────────┤
│ 【回答内容】                             │
│ ...                                     │
│                                         │
│ 【温馨提示】                             │
│ 此回答基于AI通用知识，如需了解公司      │
│ 具体政策，请联系人事部门。               │
└─────────────────────────────────────────┘
```

## 配置说明

### 相关性阈值

在`.env`文件中配置：

```bash
RELEVANCE_THRESHOLD=0.5  # 默认0.5，范围0.0-1.0
```

## 更新日志

### 2025-12-26 v2
- ✅ 优化信息来源显示方式
- ✅ 基于文档的回答不在开头显示"信息来源"
- ✅ 【文档依据】部分说明来源
- ✅ 末尾显示"📌 参考文档"列表
- ✅ 通用知识回答保留开头标识
- ✅ 避免信息重复，提升专业性

### 2025-12-26 v1
- ✅ 实现信息来源标识功能
- ✅ 所有回答在开头添加来源标识
- ✅ 增强响应数据结构
- ✅ 支持流式响应的来源标识
